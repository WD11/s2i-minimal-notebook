#!/bin/bash

set -eo pipefail

NOTEBOOK_ARGS=

# Ensure that assigned uid has entry in /etc/passwd.

if [ `id -u` -ge 10000 ]; then
    cat /etc/passwd | sed -e "s/^$NB_USER:/builder:/" > /tmp/passwd
    echo "$NB_USER:x:`id -u`:`id -g`:,,,:/home/$NB_USER:/bin/bash" >> /tmp/passwd
    cat /tmp/passwd > /etc/passwd
    rm /tmp/passwd
fi

# Ensure that assigned gid has entry in /etc/group.
user_group=`id -G`
if [ ${user_group:2} -ge 10000 ]; then
    cat /etc/group  > /tmp/group
    echo "$NB_USER:x:${user_group:2}" >> /tmp/group
    cat /tmp/group > /etc/group
    rm /tmp/group
    
fi

#将pvc-read-only赛题数据链接到jupyter工作目录
if [  ! -d '/home/jovyan/work/competition_data_ln'  ]; then
   if [  -d '/dev/public/competition_data']; then
   ln -s /dev/public/competition_data       /home/jovyan/work/competition_data_ln
   fi
fi

#给用户jovyan以sudo权限
#echo 'jovyan    ALL=(ALL:ALL) ALL'  >> /etc/sudoers

# Calculate login token from the supplied password.

if [ x"${JUPYTER_NOTEBOOK_PASSWORD}" != x"" ]; then
    NOTEBOOK_ARGS=--NotebookApp.password=`python -c "import notebook.auth; \
        print(notebook.auth.passwd(\"$JUPYTER_NOTEBOOK_PASSWORD\"))"`
    unset JUPYTER_NOTEBOOK_PASSWORD
fi

# Copy files into volume if specified and change notebook directory.

JUPYTER_NOTEBOOK_DIR=${JUPYTER_NOTEBOOK_DIR:-/home/$NB_USER/work}

if [ x"${PERSISTENT_VOLUME_ROOTDIR}" != x"" ]; then
    PERSISTENT_VOLUME_WORKSPACE=${PERSISTENT_VOLUME_WORKSPACE:-work}

    WORKDIR=${PERSISTENT_VOLUME_ROOTDIR}/${PERSISTENT_VOLUME_WORKSPACE}

    if [ ! -d ${WORKDIR} ]; then
        mkdir -p ${WORKDIR}
        cp -rp ${JUPYTER_NOTEBOOK_DIR}/. ${WORKDIR}
    fi

    JUPYTER_NOTEBOOK_DIR=${PERSISTENT_VOLUME_ROOTDIR}
fi

NOTEBOOK_ARGS="$NOTEBOOK_ARGS --notebook-dir=${JUPYTER_NOTEBOOK_DIR}"

cd ${JUPYTER_NOTEBOOK_DIR}

# Activate Python virtual environment if one exists in the volume.

if [ x"${PERSISTENT_VOLUME_ROOTDIR}" != x"" ]; then
    PERSISTENT_VOLUME_VIRTUALENV=${PERSISTENT_VOLUME_VIRTUALENV:-venv}

    VENVDIR=${PERSISTENT_VOLUME_ROOTDIR}/${PERSISTENT_VOLUME_VIRTUALENV}

    if [ -f "${VENVDIR}/bin/jupyter" ]; then
        source activate ${VENVDIR}
    fi
fi

# Start the Jupyter notebook instance.

exec /usr/local/bin/start-notebook.sh $NOTEBOOK_ARGS
